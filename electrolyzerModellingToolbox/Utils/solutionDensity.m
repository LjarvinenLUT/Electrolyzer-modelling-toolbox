function density = solutionDensity(T,molality,solute,printWarning)
% SOLUTIONDENSITY Calculates the electrolyte solution density.
%   Based on:
%   KOH:    Gösta Åkerlöf and Paul Bender. The Density of Aqueous Solutions
%           of Potassium Hydroxide. Journal of the American Chemical
%           Society 63 (4): 1085--1088, April 1941,
%           DOI: 10.1021/ja01849a054
%   NaOH:   Gösta Åkerlöf and Gerson Kegeles. The Density of Aqueous
%           Solutions of Sodium Hydroxide. Journal of American Chemical
%           Society 61 (5): 1027--1032, May 1939,
%           DOI: 10.1021/ja01874a013
%
%   Inputs:
%       T -- Temperature in kelvin
%       solute -- Chemical formula of the solute as a string or character
%                   vector: 'KOH' or 'NaOH'
%       molality -- Concentration of the solution in molality.
%
%   Output:
%       density -- Solution density
%
% See also MOLAL2MOLAR, MOLAR2MOLAL

% If printWarning not determined
if ~exist("printWarning","var")
    printWarning = true;
end

switch solute
    case 'KOH'

        % Raw matrix from the source
        rawMatrix = [0 0.0000 0.99982 0.99948 0.99800 0.99553 0.99219 0.98809 0.98330 0.97789;...
            2 .3637 1.01927 1.01822 1.01623 1.01341 1.00985 1.00562 1.00076 .99529;...
            4 .7427 1.03849 1.03681 1.03437 1.03124 1.02749 1.02315 1.01822 1.01269;...
            6 1.1377 1.05773 1.05548 1.05262 1.04922 1.04528 1.04083 1.03583 1.03026;...
            8 1.5499 1.07706 1.07429 1.07106 1.06739 1.06329 1.05872 1.05366 1.04804;...
            10 1.9804 1.09650 1.09327 1.08970 1.08579 1.08153 1.07686 1.07174 1.06607;...
            12 2.4305 1.11607 1.11243 1.10855 1.10443 1.10002 1.09526 1.09008 1.08437;...
            14 2.9016 1.13576 1.13177 1.12763 1.12332 1.11877 1.11392 1.10868 1.10293;...
            16 3.3951 1.15557 1.15130 1.14694 1.14245 1.13779 1.13285 1.12756 1.12176;...
            18 3.9126 1.17546 1.17098 1.16645 1.16183 1.15706 1.15205 1.14670 1.14087;...
            20 4.4560 1.19542 1.19082 1.18617 1.18145 1.17659 1.17151 1.16610 1.16024;...
            22 5.0273 1.21532 1.21069 1.20600 1.20122 1.19630 1.19116 1.18570 1.17981;...
            24 5.6287 1.23575 1.23094 1.22614 1.22132 1.21635 1.21115 1.20565 1.19973;...
            26 6.2625 1.25642 1.25145 1.24650 1.24154 1.23651 1.23128 1.22576 1.21982;...
            28 6.9316 1.27730 1.27219 1.26712 1.26204 1.25691 1.25159 1.24602 1.24006;...
            30 7.6389 1.29840 1.29318 1.28799 1.28280 1.27758 1.27217 1.26653 1.26054;...
            32 8.3878 1.31973 1.31442 1.30913 1.30384 1.29852 1.29302 1.28733 1.28129;...
            34 9.1821 1.34132 1.33591 1.33053 1.32514 1.31974 1.31416 1.30840 1.30232;...
            36 10.0260 1.36314 1.35766 1.35219 1.34672 1.34124 1.33558 1.32976 1.32364;...
            38 10.9244 1.38524 1.37969 1.37413 1.36857 1.36303 1.35729 1.35141 1.34524;...
            40 11.8826 1.40765 1.40199 1.39634 1.39071 1.38510 1.37930 1.37335 1.36713;...
            42 12.9070 1.43037 1.42459 1.41884 1.41313 1.40747 1.40160 1.39560 1.38932;...
            44 14.0046 1.45347 1.44751 1.44164 1.43585 1.43015 1.42422 1.41817 1.41182;...
            46 15.1834 1.47700 1.47079 1.46477 1.45889 1.45315 1.44718 1.44108 1.43465;...
            48 16.4529 1.50097 1.49442 1.48820 1.48222 1.47645 1.47045 1.46431 1.45779;...
            50 17.8240 1.52565 1.51861 1.51211 1.50600 1.50022 1.49419 1.48802 1.48139];

        % Density surface fit parameters
        p00 = 1.109;
        p01 = -0.0004008;
        p10 = 0.06803;
        p11 = -1.457e-5;
        p2 = -0.01167;
        
        
        
    case 'NaOH'

        % Raw matrix from the source
        rawMatrix = [0 0.0000 0.99982 0.99948 0.99800 0.99553 0.99219 0.98809 0.98330 0.97789;...
            2 0.5101 1.02376 1.02242 1.02022 1.01726 1.01360 1.00929 1.00434 0.99876;...
            4 1.0415 1.04708 1.04489 1.04207 1.03868 1.03473 1.03021 1.02511 1.01939;...
            6 1.5955 1.07019 1.06726 1.06390 1.06010 1.05587 1.05116 1.04592 1.04006;...
            8 2.1736 1.09321 1.08963 1.08577 1.08161 1.07711 1.07221 1.06682 1.06085;...
            10 2.7774 1.11614 1.11120 1.10773 1.10324 1.09849 1.09340 1.08787 1.08179;...
            12 3.4087 1.13900 1.13445 1.12979 1.12499 1.12000 1.11472 1.10906 1.10289;...
            14 4.0693 1.16173 1.15686 1.15192 1.14686 1.14164 1.13618 1.13040 1.12416;...
            16 4.7613 1.18433 1.17925 1.17409 1.16882 1.16340 1.15774 1.15185 1.14555;...
            18 5.4871 1.20661 1.20155 1.19628 1.19084 1.18523 1.17942 1.17340 1.16706;...
            20 6.2492 1.22863 1.22371 1.21844 1.21288 1.20711 1.20114 1.19501 1.18866;...
            22 7.0504 1.25023 1.24567 1.24049 1.23488 1.22898 1.22286 1.21662 1.21029;...
            24 7.8938 1.27133 1.26731 1.26237 1.25679 1.25078 1.24452 1.23820 1.23189;...
            26 8.7827 1.29180 1.28855 1.28402 1.27852 1.27244 1.26606 1.25965 1.25342;...
            28 9.7210 1.31150 1.30929 1.30530 1.30000 1.29389 1.28740 1.28093 1.27479;...
            30 10.7129 1.33383 1.32940 1.32612 1.32112 1.31503 1.30845 1.30192 1.29592;...
            32 11.7632 1.35683 1.34996 1.34637 1.34177 1.33576 1.32910 1.32253 1.31672;...
            34 12.8772 1.37958 1.37243 1.36590 1.36182 1.35595 1.34924 1.34267 1.33705;...
            36 14.0607 1.40198 1.39654 1.38748 1.38050 1.37547 1.36873 1.36216 1.35682;...
            38 15.3207 1.42388 1.41629 1.40906 1.40198 1.39485 1.38753 1.38089 1.37587;...
            40 16.6646 1.44515 1.43744 1.43215 1.42298 1.41585 1.40853 1.40078 1.39403;...
            42 18.1012 1.46561 1.45783 1.45047 1.44334 1.43625 1.43117 1.42138 1.41318;...
            44 19.6404 1.48505 1.47732 1.46998 1.46292 1.45591 1.44881 1.44132 1.43336;...
            46 21.2936 1.50330 1.49568 1.48847 1.48153 1.47465 1.46772 1.46070 1.45284;...
            48 23.0740 1.52008 1.51272 1.50569 1.49893 1.49226 1.48559 1.47864 1.47137;...
            50 24.9969 1.53811 1.52814 1.52142 1.51495 1.50855 1.50219 1.49561 1.48882;...
            52 27.0799 1.54827 1.54174 1.53541 1.52931 1.52326 1.51727 1.51116 1.50492];

        % Density surface fit parameters
        p00 = 1.117;
        p01 = -0.0004456;
        p10 = 0.0652;
        p11 = -1.195e-5;
        p2 = -0.01231;

end

% Empirically fit model
densityFitFunc = @(t,molal) p00 + p10*molal + p01*t + p11*molal.*t + p2*molal.*log(molal+1);

% Reference temperature vector in kelvin
tRef = [0 10 20 30 40 50 60 70]+273.15;
% Reference molality vector
molalityRef = rawMatrix(:,2);
% % Reference temperature matrix as a function of molality and temperature
% densityRef = rawMatrix(:,3:end);
if printWarning && any(T>max(tRef))
    warningMsg = "Temperature of the system, "+string(T)+...
        " K, exceeds the temperature values of the solution density data, "+string(max(tRef))+...
        " K. Concentration unit conversions are based on density values"+...
        " from an extrapolatad fit.";
    warning(warningMsg)
end
if printWarning && any(molality>max(molalityRef))
    warningMsg = "Concentration of the system, "+string(molality)+...
        " m, exceeds the concentration values of the solution density data, "+string(max(molalityRef))+...
        " m. Concentration unit conversions are based on density values"+...
        " from an extrapolatad fit.";
    warning(warningMsg)
end

density = densityFitFunc(T,molality);
    
end
